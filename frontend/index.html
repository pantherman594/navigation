<!DOCTYPE html>
<html>
  <head>
    <title>Navigation</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <script src="https://momentjs.com/downloads/moment.min.js"></script>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
        width: 70%;
        position: absolute !important;
        right: 0;
      }

      #source-des {
        padding-top: 20px;
        height: 30%;
        background-color: #4285F4;
        margin: 0 auto;
      }

      #source-des input {
        display: block;
        margin: 0 auto;
        color: white;
        padding: 10px;
        font-size: 16px;
        width: 80%;
      }

      #planning-options {
        height: 70%;
      }

      #left-wrapper {
        width: 30%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
      }

      #source-des #submit {
        color: black;
      }

      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="wrapper">
      <div id="map"></div>
      <div id="left-wrapper">
        <div id="source-des">
          <!-- Form to get the source and destination -->
          <form onsubmit="onSubmit()">
            <br>
            <input type="text" name = "source" id="source" placeholder="Choose starting point" style="border-color:darkgray; border-top:none; border-right:none; border-left:none; background-color:inherit"><br>
            <br>
            <input type="text" name="destination" id="destination" placeholder="Choose destination" style="border-color: darkgray;border-top: none; border-right: none; border-left: none; background-color: inherit"><br>
            <br>
            <input type="submit" value="Submit" name="submit" id="submit">
          </form>
        </div>
        <div id="planning-options"></div>
      </div>
    </div>
      <!-- Grab the user's location and center the map there.  -->
    <script>
      let gMap;
      let source;
      let destination;
      // create the google map widget
      // function initMap() {

      //   gMap = new google.maps.Map(document.getElementById('map'));

      //   navigator.geolocation.getCurrentPosition(function(position) {
      //     // Center on user's current location if geolocation prompt allowed
      //     var initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      //     gMap.setCenter(initialLocation);
      //     gMap.setZoom(13);
      //   }, function(positionError) {
      //     // User denied geolocation prompt - default to Boston College
      //     gMap.setCenter(new google.maps.LatLng(39.8097343, -98.5556199));
      //     gMap.setZoom(5);
      //   });
      // }

      function onSubmit() {
        event.preventDefault()
        // writes the autocompleted address to source and destination
        const source = document.getElementById("source");
        // document.getElementById("source").value = source;
        // document.getElementById("destination").value = destination;
        const destination = document.getElementById("destination");

        if (!source.value || !destination.value) return;

        Promise.all([getLatLng(source), getLatLng(destination)])
          .then(([sourceCoords, destCoords]) => {
            updateMap(sourceCoords, destCoords);
            return getRoutes(sourceCoords, destCoords);
          });
      }

      // uses open geolocation api to get the latitude and longitude data for the source/destination
      async function getLatLng(element) {
        const url = new URL('https://maps.googleapis.com/maps/api/geocode/json');

        const address = element.value;

        const params = {
          key: 'AIzaSyBAWAq1xYm7c8dlb3Z1vWAwffL5YHrvUEM',
          address,
        }
        url.search = new URLSearchParams(params);

        const response = await fetch(url);
        const data = await response.json();

        return data.results[0].geometry.location;
      }

      function updateMap(source, dest) {
        const sourcePos = new google.maps.LatLng(source.lat, source.lng);
        const destPos = new google.maps.LatLng(dest.lat, dest.lng);

        const bounds = new google.maps.LatLngBounds();

        bounds.extend(sourcePos);
        bounds.extend(destPos);

        gMap.fitBounds(bounds);

        const sourceMarker = new google.maps.Marker({
          position: sourcePos,
          label: 'A',
          map: gMap,
        });
        const destMarker = new google.maps.Marker({
          position: destPos,
          label: 'B',
          map: gMap,
        });
      }

      async function getRoutes(source, dest) {
        const url = new URL('http://localhost:8080/otp/routers/default/plan');

        const params = {
          fromPlace: `${source.lat},${source.lng}`,
          toPlace: `${dest.lat},${dest.lng}`,
          time: moment().format('h:mma'),
          date: moment().format('M-D-YYYY'),
          mode: 'TRANSIT,WALK',
          maxWalkDistance: 1609, // 1 mile in meters
        }
        url.search = new URLSearchParams(params);

        const response = await fetch(url);
        const data = await response.json();

        const route = data.plan.itineraries[0];

        const legs = route.legs;

        let lastPos = null;

        for (const leg of legs) {
          console.log(leg);
          const from = new google.maps.LatLng(leg.from.lat, leg.from.lon);
          const to = new google.maps.LatLng(leg.to.lat, leg.to.lon);

          const routeMarker = new google.maps.Marker({
            position: to,
            map: gMap,
          });

          for (const step of leg.steps) {
            const pos = new google.maps.LatLng(step.lat, step.lon);

            if (lastPos) {
              const path = new google.maps.Polyline({     
                path: [lastPos, pos],
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2,
              });    
              path.setMap(gMap);
            }

            lastPos = pos;
          }
        }
      }

      function initMap() {
        gMap = new google.maps.Map(document.getElementById('map'));

        navigator.geolocation.getCurrentPosition(function(position) {
          // Center on user's current location if geolocation prompt allowed
          var initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          gMap.setCenter(initialLocation);
          gMap.setZoom(13);
        }, function(positionError) {
          // User denied geolocation prompt - default to Chicago
          gMap.setCenter(new google.maps.LatLng(39.8097343, -98.5556199));
          gMap.setZoom(5);
        });
       
        //Autocompletes address information
        source = new google.maps.places.Autocomplete(document.getElementById('source'), { types: [ 'geocode' ] });
        google.maps.event.addListener(source, 'place_changed', function() {
          //fillInAddress();
        });

        destination = new google.maps.places.Autocomplete(document.getElementById('destination'), { types: [ 'geocode' ] });
        google.maps.event.addListener(destination, 'place_changed', function() {
          //fillInAddress();
        });
        //var input = document.getElementById('destination');
        //gMap.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
                
        // var autocomplete = new google.maps.places.Autocomplete(input);

        //Moves map to source address
        // autocomplete.addListener('place_changed', function() {
        //   infowindow.close();
        //   marker.setVisible(false);
        //   var place = autocomplete.getPlace();
        //   if (!place.geometry) {
        //     // User entered the name of a Place that was not suggested and
        //     // pressed the Enter key, or the Place Details request failed.
        //     window.alert("No details available for input: '" + place.name + "'");
        //     return;
        // }
        // });
      }
      
        
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBAWAq1xYm7c8dlb3Z1vWAwffL5YHrvUEM&callback=initMap&libraries=places"
    async defer></script>
  </body>
</html>
