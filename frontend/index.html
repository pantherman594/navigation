<!DOCTYPE html>
<html>
  <head>
    <title>Navigation</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
        width: 80%;
        position: absolute !important;
        right: 0;
      }

      #source-des {
        height: 30%;
        width: 20%;
        position: absolute !important;
        left: 0;
        top: 0;
      }

      #planning-options {
        height: 70%;
        width: 20%;
        position: absolute !important;
        left: 0;
        bottom: 0;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="source-des" style="background-color: #4285F4;">
      <!-- Form to get the source and destination -->
      <form onsubmit="onSubmit()" style="position: absolute;top: 50%;left: 50%;margin-left: -37%;margin-top: -32%;">
        <br>
        <input type="text" name = "source" id="source" placeholder="Choose starting point..." style="border-color:darkgray; border-top:none; border-right:none; border-left:none; background-color:inherit"><br>
        <br>
        <input type="text" name="destination" id="destination" placeholder="Choose destination..." style="border-color: darkgray;border-top: none; border-right: none; border-left: none; background-color: inherit"><br>
        <br>
        <input type="submit" value="Submit" name="form" id="form">
      </form>
    </div>
    <div id="planning-options"></div>
      <!-- Grab the user's location and center the map there.  -->
    <script>
      let source = '';
      let destination = '';
      let data = '';
      let sourceLatLng = '';
      let destinationLatLng = '';
      
      document.getElementById('source').addEventListener("input", function(){
        autoFind('source');
      });

      document.getElementById('destination').addEventListener("input", function(){
        autoFind('destination');
      });

      // create the google map widget
      // function initMap() {

      //   gMap = new google.maps.Map(document.getElementById('map'));

      //   navigator.geolocation.getCurrentPosition(function(position) {
      //     // Center on user's current location if geolocation prompt allowed
      //     var initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      //     gMap.setCenter(initialLocation);
      //     gMap.setZoom(13);
      //   }, function(positionError) {
      //     // User denied geolocation prompt - default to Boston College
      //     gMap.setCenter(new google.maps.LatLng(39.8097343, -98.5556199));
      //     gMap.setZoom(5);
      //   });
      // }

      function onSubmit() {
        event.preventDefault()
        // writes the autocompleted address to source and destination
        source = document.getElementById("source").value;
        // document.getElementById("source").value = source;
        // document.getElementById("destination").value = destination;
        destination = document.getElementById("destination").value;
        getLatLng('source');
        getLatLng('destination');
      }

      // Use place autocomplete api to find the data for the source/destination
      async function autoFind(userInput) {
        let type = '';
        if (userInput == 'source') {
          type = 'source';
        } else {
          type = 'destination';
        }

        const url = 'https://cors-anywhere.herokuapp.com/https://maps.googleapis.com/maps/api/place/autocomplete/json?components=country:us&types=address&input='
        let input = document.getElementsByName(type)[0].value;

        const response = await fetch(url + input + '&key=AIzaSyBAWAq1xYm7c8dlb3Z1vWAwffL5YHrvUEM', {
        });
        data = await response.json();

        console.log(data.predictions[0].description);

        if (type == 'source') {
          source = data.predictions[0].description;
        } else {
          destination = data.predictions[0].description;
        }
      }

      // uses open geolocation api to get the latitude and longitude data for the source/destination
      async function getLatLng(type) {
        const url = 'http://open.mapquestapi.com/geocoding/v1/address?key=ndy3lEKEGEj3FIGsShsuQVZ5QqtakWer';
        let address = '';

        if (type == 'source') {
          address = source.split(' ').join('+');
        } else {
          address = destination.split(' ').join('+');
        }

        console.log(address);

        const response = await fetch(url + '&location=' + address, {
        });
        data = await response.json();

        if (type == 'source') {
          sourceLatLng = data.results[0].locations[0].latLng;
          console.log(sourceLatLng);
        } else {
          destinationLatLng = data.results[0].locations[0].latLng;
          console.log(destinationLatLng);
        }
      }

      function initMap() {
        var gMap = new google.maps.Map(document.getElementById('map'));

        navigator.geolocation.getCurrentPosition(function(position) {
          // Center on user's current location if geolocation prompt allowed
          var initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          gMap.setCenter(initialLocation);
          gMap.setZoom(13);
        }, function(positionError) {
          // User denied geolocation prompt - default to Chicago
          gMap.setCenter(new google.maps.LatLng(39.8097343, -98.5556199));
          gMap.setZoom(5);
        });
       
        //Autocompletes address information
        source = new google.maps.places.Autocomplete(document.getElementById('source'), { types: [ 'geocode' ] });
        google.maps.event.addListener(source, 'place_changed', function() {
          //fillInAddress();
        });

        destination = new google.maps.places.Autocomplete(document.getElementById('destination'), { types: [ 'geocode' ] });
        google.maps.event.addListener(destination, 'place_changed', function() {
          //fillInAddress();
        });
        //var input = document.getElementById('destination');
        //gMap.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
                
        // var autocomplete = new google.maps.places.Autocomplete(input);

        //Moves map to source address
        // autocomplete.addListener('place_changed', function() {
        //   infowindow.close();
        //   marker.setVisible(false);
        //   var place = autocomplete.getPlace();
        //   if (!place.geometry) {
        //     // User entered the name of a Place that was not suggested and
        //     // pressed the Enter key, or the Place Details request failed.
        //     window.alert("No details available for input: '" + place.name + "'");
        //     return;
        // }
        // });
      }
      
        
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBAWAq1xYm7c8dlb3Z1vWAwffL5YHrvUEM&callback=initMap&libraries=places"
    async defer></script>
  </body>
</html>